// Global error handlers (mantenha se tiver)
window.addEventListener('unhandledrejection', e => console.error('Promise rejection:', e.reason));
window.addEventListener('error', e => console.error('Error:', e.error || e.message));

// Navegação e funções auxiliares (copie suas existentes: navigateTo, mostrarMensagem, etc.)

// FUNÇÃO CORRIGIDA: atualizarLista (cap 24)
async function atualizarLista() {
  try {
    const data = await fetch('/confirmados').then(r => r.json());
    let confirmed = Array.isArray(data) ? data.slice(0, 24) : (data.confirmed || []).slice(0, 24);
    const contador = document.getElementById('contadorConfirmados');
    if (contador) contador.textContent = confirmed.length;

    const ul = document.getElementById('listaConfirmados');
    if (ul) {
      ul.innerHTML = '';
      confirmed.forEach((c, i) => {
        const li = document.createElement('li');
        li.className = `lista-item ${c.tipo === 'avulso' ? 'avulso' : ''}`;
        const info = document.createElement('div');
        info.className = 'info';
        const nome = document.createElement('span');
        nome.className = 'nome';
        nome.textContent = `${i + 1}. ${c.nome}`;
        info.appendChild(nome);
        const tipoBadge = document.createElement('span');
        tipoBadge.className = `badge badge-${c.tipo}`;
        tipoBadge.textContent = c.tipo === 'mensalista' ? 'M' : 'A';
        tipoBadge.title = c.tipo;
        info.appendChild(tipoBadge);
        if (c.genero) {
          const generoBadge = document.createElement('span');
          generoBadge.className = `badge badge-${c.genero}`;
          generoBadge.textContent = c.genero === 'masculino' ? '♂' : '♀';
          generoBadge.title = c.genero;
          info.appendChild(generoBadge);
        }
        li.appendChild(info);
        const btn = document.createElement('button');
        btn.className = 'btn-remove';
        btn.textContent = '✕';
        btn.title = `Remover ${c.nome}`;
        btn.addEventListener('click', () => removerConfirmado(c.id));
        li.appendChild(btn);
        ul.appendChild(li);
      });
    }
  } catch (err) {
    console.error('Erro lista:', err);
  }
}

// SORTEIO CORRIGIDO: exatamente como regras (24 max, 4x6, intercalado, vagas só <24)
function sortearTimes(confirmados) {
  console.log('Sorteio: confirmados recebidos:', confirmados.length); // DEBUG
  const MAX_JOGADORES = 24;
  const NUM_TIMES = 4;
  const MAX_POR_TIME = 6;
  const totalConfirmados = Math.min(confirmados.length, MAX_JOGADORES);
  let jogadores = confirmados.slice(0, MAX_JOGADORES);
  jogadores.forEach(c => c.genero ||= 'masculino');

  const homens = jogadores.filter(c => c.genero === 'masculino');
  const mulheres = jogadores.filter(c => c.genero === 'feminino');
  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }
  shuffle(homens); shuffle(mulheres);

  // INTERCALA M-H para balanceio
  const combinado = [];
  let mi = 0, hi = 0;
  while (mi < mulheres.length || hi < homens.length) {
    if (mi < mulheres.length) combinado.push(mulheres[mi++]);
    if (hi < homens.length) combinado.push(homens[hi++]);
  }
  console.log('Combinado (intercalado):', combinado.length); // DEBUG

  // DISTRIBUI ROUND-ROBIN: exatamente 6 max por time
  const times = Array(NUM_TIMES).fill().map(() => []);
  combinado.forEach((jogador, idx) => {
    const timeIdx = idx % NUM_TIMES;
    if (times[timeIdx].length < MAX_POR_TIME) {
      times[timeIdx].push(jogador);
    }
  });

  // VAGAS SÓ SE <24 CONFIRMADOS
  if (totalConfirmados < MAX_JOGADORES) {
    times.forEach(time => {
      while (time.length < MAX_POR_TIME) time.push({ nome: 'Vaga Livre', genero: '', tipo: '' });
    });
  }
  console.log('Times finais:', times.map(t => ({ len: t.length, reais: t.filter(p => p.nome !== 'Vaga Livre').length }))); // DEBUG
  return times;
}

// EVENT BOTÃO SORTEAR (substitua o seu)
document.getElementById('sortearTimes')?.addEventListener('click', async () => {
  try {
    const data = await fetch('/confirmados').then(r => r.json());
    const list = Array.isArray(data) ? data : (data.confirmed || []);
    console.log('List para sorteio:', list.length); // DEBUG
    const times = sortearTimes(list);

    let html = '<div class="times-grid">';
    times.forEach((time, i) => {
      html += `<div class="time-card"><h4>Time ${i+1}</h4><ul>`;
      time.forEach(p => {
        const generoBadge = p.genero ? `<span class="badge badge-${p.genero}">${p.genero === 'masculino' ? '♂' : '♀'}</span>` : '';
        html += `<li>${p.nome}${generoBadge}</li>`;
      });
      html += '</ul></div>';
    });
    html += '</div><div style="margin-top:16px;color:#34d399;">Versão corrigida 16/01/2026 - Sem vagas extras!</div>';
    document.getElementById('resultadoSorteio').innerHTML = html;

    // WhatsApp (mantenha seu código)
    // ...
  } catch (err) {
    console.error('Erro sorteio:', err);
  }
});

// Outras funções (removerConfirmado, formConfirma, limpar, etc. - mantenha as suas)

// Inicializa
atualizarLista();
